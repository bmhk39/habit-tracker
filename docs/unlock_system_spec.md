# 段階的アンロック＆習慣化済みシステム 仕様書

**ステータス**: 未実装（設計段階）  
**作成日**: 2026-01-13  
**最終更新**: 2026-01-13

---

## 設計思想

> 意気込みだけで習慣を一気に追加し、達成できずにやめてしまう「三日坊主パターン」を防ぐ。  
> スモールステップで自己効力感を積み上げる設計。

**科学的根拠**:
- 習慣形成には平均 **66日** かかる（UCL Phillippa Lally博士, 2009年研究）
- 個人差があり18日〜254日の幅がある
- 1日サボっても致命的ではないが、一貫性が重要

---

## 継続日数ルール

### 基本方針

**「毎日継続」が基本だが、1日だけの未達成は許容する。**

| 状態 | 継続日数の扱い |
|------|----------------|
| 毎日達成 | 継続カウント +1 |
| **1日だけ**未達成 | 継続維持（猶予） |
| **2日連続**未達成 | **継続リセット（0日に戻る）** |

**理由**: 研究でも「1日サボっても致命傷ではない」と示されているが、2日連続は習慣の断絶とみなす。厳しすぎず、緩すぎないバランス。

### 継続日数カウントの例

```
日付:     1/1  1/2  1/3  1/4  1/5  1/6  1/7
達成:      ✓    ✓    ✓    ✗    ✓    ✓    ✓
継続日数:  1    2    3    3    4    5    6   ← 1/4の1日だけ未達成は許容
```

```
日付:     1/1  1/2  1/3  1/4  1/5  1/6  1/7
達成:      ✓    ✓    ✓    ✗    ✗    ✓    ✓
継続日数:  1    2    3    3    0    1    2   ← 2日連続でリセット
```

---

## 未達成時のリカバリーフロー

### 概要

未達成がある習慣は、通常の達成ボタン（○/✓）の代わりに**警告アイコン（⚠️）**を表示し、タップ時にユーザーと対話して状況を確認・処理する。

| 未達成状態 | 表示 | タップ時の動作 |
|------------|------|----------------|
| 昨日のみ未達成（今日はまだ） | ⚠️（黄色警告） | リカバリーダイアログ表示 |
| 2日以上未達成 | ⚠️（赤警告） | 継続リセット確認ダイアログ表示 |
| 通常（未達成なし） | ○ / ✓ | 通常の達成トグル |

---

### パターンA: 昨日のみ未達成

**状況**: 今日を含めてまだ2日連続未達成ではないが、昨日の記録がない。

**ユーザーの可能性**:
1. 昨日は本当にやらなかった
2. 昨日やったけど記録し忘れた
3. 今日はもうやった（ボタンを押しに来た）

**UIフロー案**:

```
┌─────────────────────────────────────┐
│ ⚠️ 「筋トレ10分」の確認            │
│                                     │
│ 昨日（1/12）の記録がありません。    │
│ 現在の継続: 🔥 15日                 │
│                                     │
│ ──────────────────────────────────  │
│ 昨日はどうでしたか？                │
│                                     │
│ ○ やったけど記録し忘れた            │
│   → 昨日を達成済みにする            │
│                                     │
│ ○ やらなかった                      │
│   → 今日やらないと継続が途切れます  │
│                                     │
│ ──────────────────────────────────  │
│ 今日はどうですか？                  │
│                                     │
│ ☐ 今日はもう達成した                │
│                                     │
│         [キャンセル]  [確定]        │
└─────────────────────────────────────┘
```

**処理ロジック**:
| 昨日 | 今日 | 結果 |
|------|------|------|
| 記録忘れ（達成扱い） | 達成 | 継続 +2日 |
| 記録忘れ（達成扱い） | 未達成 | 継続 +1日（昨日分）、今日は未達成 |
| やらなかった | 達成 | 継続維持（1日猶予使用）、今日 +1日 |
| やらなかった | 未達成 | 警告表示のまま、翌日まで猶予 |

---

### パターンB: 2日以上未達成

**状況**: 記録上、2日以上連続で未達成になっている。継続リセットの可能性。

**ユーザーの可能性**:
1. 本当に2日以上やらなかった → リセット
2. 記録し忘れていただけ → 遡って達成記録をつける
3. 1日だけやらなかったが、他は記録忘れ → 部分的に達成記録

**UIフロー案**:

```
┌─────────────────────────────────────┐
│ ⚠️ 「筋トレ10分」の確認            │
│                                     │
│ 2日以上記録がありません。           │
│ このままだと継続日数がリセット      │
│ されます。                          │
│                                     │
│ 現在の継続: 🔥 15日 → 0日?          │
│                                     │
│ ──────────────────────────────────  │
│ 未記録の日を確認してください        │
│                                     │
│ 1/11 (土) ○やった  ○やらなかった   │
│ 1/12 (日) ○やった  ○やらなかった   │
│ 1/13 (月) ☐ 今日はもう達成した      │
│                                     │
│ ──────────────────────────────────  │
│ ※2日連続「やらなかった」がある場合 │
│   継続日数は0にリセットされます     │
│                                     │
│         [キャンセル]  [確定]        │
└─────────────────────────────────────┘
```

**処理ロジック**:
- ユーザーが各日の状況を申告
- 2日連続未達成が確定 → 継続リセット（0日から再カウント）
- 連続未達成が1日以内に収まる → 継続維持

---

### UI表示まとめ

| 状態 | ボタン表示 | 色 | タップ動作 |
|------|------------|-----|-----------|
| 今日未達成（昨日達成） | ○ | 通常 | 達成トグル |
| 今日達成済み | ✓ | 緑 | 達成トグル（確認あり） |
| **昨日のみ未達成** | ⚠️ | 黄色/オレンジ | リカバリーダイアログ |
| **2日以上未達成** | ⚠️ | 赤 | リセット確認ダイアログ |

---

## 1. 習慣追加の段階的アンロック

### 基本ルール

| 条件 | 追加可能な習慣数 |
|------|------------------|
| アプリ開始時 | **1つのみ** |
| 最初の習慣を3日連続達成 | **+2つ**（計3つまで） |
| 以降 | 未定（運用しながら調整） |

### オンボーディング（初回習慣追加時）

習慣追加画面に表示するメッセージ：

> **まずは1つから始めましょう**
> 
> 習慣を一度にたくさん始めようとすると、どれも続かなくなりがちです。
> 
> まずはスモールステップで、あなたが「これならできる」と自信のある**小さな習慣**から始めましょう。
> 
> 3日間続けられたら、新しい習慣を追加できるようになります。

### 未確定事項

- [ ] 3日達成後、さらに増やすルールは？（例: 21日達成で+1枠、習慣化済み移動で+1枠）
- [ ] 習慣の最大数に上限を設けるか？
- [ ] 既存ユーザー（すでに複数習慣を持っている）への対応

---

## 2. 習慣化済みリスト（66日ルール）

### 解禁条件

**66日間達成**した習慣は「習慣化済みリスト」への移動が**任意で**可能になる。

### 習慣化済みリストの挙動

| 項目 | 内容 |
|------|------|
| ユーザー操作 | **不要**。毎日自動で「達成」としてカウントされ続ける |
| 表示場所 | 通常の習慣リストとは**別セクション**または別画面 |
| 目的 | 「こんなに続けてきたんだ」というログ・モチベーション維持 |

### UI案

```
┌─────────────────────────────────┐
│ 📋 今日の習慣                   │
│ ┌─────────────────────────────┐ │
│ │ ○ 筋トレ10分      🔥 12日   │ │
│ │ ✓ 読書15分        🔥 45日   │ │
│ └─────────────────────────────┘ │
│                                 │
│ 🏆 習慣化済み                   │
│ ┌─────────────────────────────┐ │
│ │ ✓ 水2L飲む        🔥 234日  │ │
│ │ ✓ 朝のストレッチ  🔥 189日  │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

### 確定事項

- [x] **66日は「継続日数」でカウント**（1日だけの未達成は許容、2日連続未達成でリセット）
- [x] 習慣化済みリストへの移動は**任意**

### 未確定事項

- [ ] 習慣化済みアイテムにも達成ボタンを表示するか？（押す必要はないが、タップで詳細を見れる等）

---

## 3. 習慣化済みからの復帰

「やっぱりまだ定着していなかった」と感じた場合、いつでも通常リストに戻せる。

### 復帰時の選択肢

| オプション | 説明 | 想定ユースケース |
|------------|------|------------------|
| **継続日数リセット** | 0日から再カウント | 長期間サボっていて、心機一転やり直したい |
| **現在のまま戻す** | 自動カウント日数を維持、当日は「未達成」状態 | ちょっと油断しただけ、記録は消したくない |
| **手動調整** | 「-3日」など、ユーザーが日数を自由に調整 | 実態に合わせて微調整したい |

### UI案（復帰ダイアログ）

```
┌─────────────────────────────────┐
│ 「朝のストレッチ」を習慣リストに │
│ 戻しますか？                    │
│                                 │
│ 現在の継続日数: 189日           │
│                                 │
│ ○ このまま戻す（今日は未達成）  │
│ ○ 0日にリセットして戻す        │
│ ○ 日数を調整して戻す: [___] 日  │
│                                 │
│      [キャンセル]  [戻す]       │
└─────────────────────────────────┘
```

---

## 4. データ構造（案）

```javascript
// Firestore: users/{userId}/habits/{habitId}
{
  name: "朝のストレッチ",
  createdAt: Timestamp,
  order: 0,
  
  // 新規追加フィールド
  status: "active" | "graduated",  // active: 通常リスト, graduated: 習慣化済み
  graduatedAt: Timestamp | null,   // 習慣化済みに移動した日時
  streakAtGraduation: 66,          // 移動時点の継続日数（復帰時の参考用）
  
  logs: {
    "2026-01-13": { done: true, completedAt: "...", auto: false },
    "2026-01-14": { done: true, completedAt: "...", auto: true },  // 自動カウント
    ...
  }
}

// Firestore: users/{userId}/settings/general
{
  dayStartHour: 4,
  
  // 新規追加フィールド
  unlockedSlots: 1,          // 現在の習慣追加枠
  firstHabitUnlocked: false, // 最初の3日達成済みか
}
```

---

## 5. 実装優先度（案）

| 優先度 | 機能 | 理由 |
|--------|------|------|
| P1 | 習慣追加枠の制限（1つ→3つ） | コア機能、最初に入れないと意味がない |
| P1 | オンボーディングメッセージ | ユーザーにルールを理解してもらうため必須 |
| P2 | 習慣化済みリストへの移動 | 66日後まで使われない、後回しでOK |
| P2 | 習慣化済みの自動カウント | 同上 |
| P3 | 復帰機能 | さらに後で使われる機能 |

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-13 | 継続日数ルール追加（1日猶予あり、2日連続でリセット）。未達成時のリカバリーフローUI案追加。 |
| 2026-01-13 | 初版作成。基本仕様を策定。 |
